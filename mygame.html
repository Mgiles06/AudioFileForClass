<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Mark's Final Project Game Name</title>
        <style>
            table, th, td {
                border:1px solid black;
            }
            .storyColumn {
                float: left;
                width: 70%;
            }
            .statsColumn {
                float: right;
                width: 30%;
            }
            /* Clear floats after the columns */
            .row:after {
                content: "";
                display: table;
                clear: both;
            }
            .canvasContainer {
                margin: auto;
                width: 50%;
            }
        </style>
	</head>
	<body>
        <div id="startScreen">
            <button type="button" id="startBtn">Start Game!</button>
            <img src="https://mgiles06.github.io/AudioFileForClass/dungeon.jpeg">
        </div>
	    <div class="row" id="gameContents">
            <div class="storyColumn">
                <h1>Mark's Final Project The Dungeon</h1>
                <p>Time: <span id='timer'>00:00</span></p>
                <p>Your Objective: Make it out of the Dungeon alive</p>
                <p>Game Controls: Press (1-5) to select an option. Press 'i' to view your inventory. Press 'e' to eat a mushroom. Press 'v' to show/hide the cheat code entry and result section.</p>
                <p><span id='storyContainer'></span></p>
                <table style="width:100%">
                    <tr>
                        <td id = "Choice1" style="display: block">Test</td>
                        <td id = "Choice2" style="display: block">Test</td>
                        <td id = "Choice3" style="display: block">Test</td>
                        <td id = "Choice4" style="display: block">Test</td>
                        <td id = "Choice5" style="display: block">Test</td>
                    </tr>
                </table>
                <p id="user_input"></p>
                <p id="cheat_message">Nothing</p>
                <img id="winner" src="https://mgiles06.github.io/AudioFileForClass/winner.png">
                <img id="loser" src="https://mgiles06.github.io/AudioFileForClass/death.png">
            </div>
            <div class="statsColumn">
                <div class="canvasContainer">
                    <p><strong>Player Status</strong></p>
                    <p>Health: <span id=playerHealth></span> &emsp; Sanity: <span id=playerSanity></span></p>
                    <p>Armour Condition: <span id=armourDurability></span></p>
                    <p>Weapon Condition: <span id=weaponDurability></span></p>
                    <canvas id="canvas" style="border:thin solid;" width="300" height="300"></canvas>
                </div>
                <p id="revealCheatCodes"></p>
            </div>
	    </div>
		<script>
            var playerObj, weakarmorObj, weakswordObj;

            const GAME_EVENTS = new Array();
            const MUSHROOM_INDEX = 0;
            const ARMOUR_INDEX = 1;
            const WEAPON_INDEX = 2;
            const MAX_CHOICES = 5;
            const userInputDisplay = document.getElementById("user_input");
            const cheatMessage = document.getElementById("cheat_message");
            userInputDisplay.style.display = "none";
            cheatMessage.style.display = "none";
            const CHEAT_CODES_TEXT = "CHEAT CODES UNLOCKED! \n'shrooms' -> Adds 100 mushrooms\n'hlppls' -> Show cheats\n'outofhr -> Automatic Win";

            var currentEvent;
            var width, height = 300;
            var statusId;
            var timerId;
            var count = 0;

            var playerCanvas = document.getElementById("canvas");
            playerCanvas.style.backgroundColor = "white";
            var context = canvas.getContext("2d");

            var gameContents = document.getElementById("gameContents");
            gameContents.style.display = "none";
            var winnerPic = document.getElementById("winner");
            winnerPic.style.display = "none";
            var loserPic = document.getElementById("loser");
            loserPic.style.display = "none";
            var startScreen = document.getElementById("startScreen");

            document.getElementById("startBtn").addEventListener("click", function() {
                startScreen.style.display = "none";
                gameContents.style.display = "block";
                timerId = setInterval(updateTimer,1000);
            });

	        var healthStatus = document.getElementById("playerHealth");
            var sanityStatus = document.getElementById("playerSanity");
            var armourStatus = document.getElementById("armourDurability");
            var weaponStatus = document.getElementById("weaponDurability");

            function randomNumber(min, max){                               
                return Math.floor(Math.random() * (max - min + 1)) + min;  
            }

            function updateTimer(){
                var SECONDS = 60;
                var MINUTES = 60;
                count++;
				var hours, minutes, seconds;
				displayString = "";
                hours = Math.floor(count/(SECONDS*MINUTES));
                minutes = Math.floor(count/(SECONDS)) - hours * MINUTES;
				seconds = count - (hours*MINUTES*SECONDS) - (minutes*SECONDS);
				if(hours==0){
                    displayString+="00:";
                } else if(hours<10){
                    displayString+="0"+hours+":";
                } else {
                    displayString+=hours+":";
                }
                if(minutes==0){
                    displayString+="00:";
                } else if(minutes<10){
                    displayString+="0"+minutes+":";
                } else {
                    displayString+=minutes+":";
                }
                if(seconds<10){
                    displayString+="0"+seconds;
                } else {
                    displayString+=seconds;
                }
				timer.innerText=displayString;
			}

            function updatePlayerStatus(status, amount){
                context.clearRect(0, 0, playerCanvas.width, playerCanvas.height);
                // Draw the eyes
                context.beginPath();
                context.arc(120, 100, 20, 0, 2 * Math.PI);
                context.stroke()
                context.beginPath();
                context.arc(180, 100, 20, 0, 2 * Math.PI);
                context.stroke()
                switch(status){
                    case "happy":
                        context.beginPath();
                        context.arc(150, 160, 90, 0, 1 * Math.PI);
                        context.stroke()
                        context.beginPath();
                        context.arc(120, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        context.beginPath();
                        context.arc(180, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        break;
                    case "alright":
                        context.beginPath();
                        context.moveTo(80, 200);
                        context.lineTo(220, 200)
                        context.stroke()
                        context.beginPath();
                        context.arc(120, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        context.beginPath();
                        context.arc(180, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        break;
                    case "sad":
                        context.beginPath();
                        context.arc(150, 250, 80, 0 * Math.PI, 1 * Math.PI, 1 * Math.PI);
                        context.stroke()
                        context.beginPath();
                        context.arc(120, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        context.beginPath();
                        context.arc(180, 100, 5, 0, 2 * Math.PI);
                        context.fill();
                        context.beginPath();
                        context.moveTo(180, 120);
                        context.lineTo(190, 140)
                        context.stroke()
                        context.beginPath();
                        context.moveTo(180, 120);
                        context.lineTo(170, 140)
                        context.stroke()
                        context.beginPath();
                        context.arc(180, 140, 10, 0, 1 * Math.PI);
                        context.stroke()
                        break;
                    case "dead":
                        context.beginPath();
                        context.arc(150, 250, 80, 0 * Math.PI, 1 * Math.PI, 1 * Math.PI);
                        context.stroke()
                        context.beginPath();
                        context.moveTo(160, 120);
                        context.lineTo(200, 80)
                        context.stroke()
                        context.beginPath();
                        context.moveTo(160, 80);
                        context.lineTo(200, 120)
                        context.stroke()
                        context.beginPath();
                        context.moveTo(100, 120);
                        context.lineTo(140, 80)
                        context.stroke()
                        context.beginPath();
                        context.moveTo(100, 80);
                        context.lineTo(140, 120)
                        context.stroke()
                        break;
                    case "setH":
                        healthStatus.innerText = amount;
                        break;
                    case "setS":
                        sanityStatus.innerText = amount;
                        break;
                    case "setArmour":
                        armourStatus.innerText = amount;
                        break;
                    case "setWeapon":
                        weaponStatus.innerText = amount;
                        break;
                }
            }

            function keyListener(){
                switch(event.key){
                    case "1":
                        if(currentEvent.choices[0]){
                            if (currentEvent.outcomes[0].gameEvent){
                                currentEvent.outcomes[0].gameEvent();
                            }
                            currentEvent = currentEvent.outcomes[0];
                            updateChoices(currentEvent);
                        }
                        break;
                    case "2":
                        if(currentEvent.choices[1]){
                            if (currentEvent.outcomes[1].gameEvent){
                                currentEvent.outcomes[1].gameEvent();
                            }
                            currentEvent = currentEvent.outcomes[1];
                            updateChoices(currentEvent);
                        }
                        break;
                    case "3":
                        if(currentEvent.choices[2]){
                            if (currentEvent.outcomes[2].gameEvent){
                                currentEvent.outcomes[2].gameEvent();
                            }
                            currentEvent = currentEvent.outcomes[2];
                            updateChoices(currentEvent);
                        }
                        break;
                    case "4":
                        if(currentEvent.choices[3]){
                            if (currentEvent.outcomes[3].gameEvent){
                                currentEvent.outcomes[3].gameEvent();
                            }
                            currentEvent = currentEvent.outcomes[3];
                            updateChoices(currentEvent);
                        }
                        break;
                    case "5":
                        if(currentEvent.choices[4]){
                            if (currentEvent.outcomes[4].gameEvent){
                                currentEvent.outcomes[4].gameEvent();
                            }
                            currentEvent = currentEvent.outcomes[4];
                            updateChoices(currentEvent);
                        }
                        break;
                    case "e":
                        playerObj.inventory[MUSHROOM_INDEX].eatMushroom();
                        break;
                    case "i":
                        var stringToAlert = "You have "
                        var mushrooms = playerObj.inventory[MUSHROOM_INDEX];
                        stringToAlert += mushrooms.quantity + " strange mushrooms, ";
                        stringToAlert += playerObj.inventory[ARMOUR_INDEX].name + " and a ";
                        stringToAlert += playerObj.inventory[WEAPON_INDEX].name; 
                        alert(stringToAlert);
                        break;
                    case "v":
                        if (userInputDisplay.style.display === "none" && cheatMessage.style.display === "none") {
                            userInputDisplay.style.display = "block";
                            cheatMessage.style.display = "block";
                        } else {
                            userInputDisplay.style.display = "none";
                            cheatMessage.style.display = "none";
                        }
                        break;
                }
            }

            window.addEventListener("keypress", keyListener);

            var winGame = {"text": "You made it out",
            "gameEvent": function() {
                winnerPic.style.display = "block";
                clearInterval(timerId);
            }, "choices" : []};

            // Found how to add cheat codes by viewing this post: https://javascript.plainenglish.io/how-to-detect-a-sequence-of-keystrokes-in-javascript-83ec6ffd8e93
            // CHEAT CODE IMPLEMENTATION START
            // keydown listener on the page for tracking sequence of keys pressed
            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                    eventType: 'keydown',
                    keystrokeDelay: 1000
                };

                keyMapper([updateUI], options);
            });

            // responsible for mapping the keys pressed and determining the delay between keystrokes
            function keyMapper(callbackList, options) {
                const delay = hasProperty('keystrokeDelay', options) && options.keystrokeDelay >= 300 && options.keystrokeDelay;
                const keystrokeDelay = delay || 1000;
                const eventType = hasProperty('eventType', options) && options.eventType || 'keydown';

                let state = {
                    buffer: [],
                    lastKeyTime: Date.now()
                };

                document.addEventListener(eventType, event => {
                    const key = event.key;
                    const currentTime = Date.now();
                    let buffer = [];

                    if (currentTime - state.lastKeyTime > keystrokeDelay) {
                        buffer = [key];
                    } else {
                        buffer = [...state.buffer, key];
                    }

                    state = {buffer: buffer, lastKeyTime: currentTime};

                    callbackList.forEach(callback => callback(buffer));
                });

                function hasProperty(property, object) {
                    return object && object.hasOwnProperty(property);
                }
            }

            // Updates the userInput of current keySequence they have entered as well as the cheatMessage
            function updateUI(keySequence) {
                const userInput = keySequence.join('').toLowerCase();
                const keySequences = {
                    'shrooms': 'Adds 100 mushrooms',
                    'hlppls': "Show cheats",
                    'outofhr': "Automatic Win"
                };
                userInputDisplay.innerText = userInput;
                cheatMessage.innerText = keySequences[userInput] || 'Nothing';

                if (keySequences[userInput]) {
                    switch(keySequences[userInput]){
                        case 'Adds 100 mushrooms':
                            playerObj.inventory[MUSHROOM_INDEX].quantity += 100;
                            alert("You got 100 mushrooms");
                            break;
                        case 'Show cheats':
                            document.getElementById("revealCheatCodes").innerText = CHEAT_CODES_TEXT;
                            break;
                        case 'Automatic Win':
                            updateChoices(winGame);
                            break;
                    }
                }
            }
            // CHEAT CODE IMPLEMENTATION END

            function setupPlayer() {
                var mushroomsObj = {"quantity": 0, "eatMushroom" : function(){ eatMushroom(this)}};
                weakarmourObj = {"name" : "light armour", "durability" : 25};
                weakswordObj = {"name" : "wooden sword", "durability" : 10};
                playerObj = { "health" : 150, "sanity": 50, "inventory" : [mushroomsObj, weakarmourObj, weakswordObj]};
                updatePlayerStatus("setH", playerObj.health);
                updatePlayerStatus("setS", playerObj.sanity);
                updatePlayerStatus("setArmour", playerObj.inventory[ARMOUR_INDEX].durability);
                updatePlayerStatus("setWeapon", playerObj.inventory[WEAPON_INDEX].durability);
                updatePlayerStatus("happy");
            }

            function eatMushroom(mushroom) {
                if (mushroom.quantity>0){
                    playerObj.health += randomNumber(-5,25);
                    updatePlayerStatus("setH", playerObj.health);
                    mushroom.quantity--;
                    console.log(playerObj);
                }
                else {
                    alert("You have no mushrooms");
                }
            }

            function addItemToInventory(item){
                switch(item){
                    case "Mushroom":
                        playerObj.inventory[MUSHROOM_INDEX].quantity++;
                        console.log(playerObj);
                        break;
                    case "setArmour":
                        playerObj.inventory[ARMOUR_INDEX] = item;
                        updatePlayerStatus("setArmour", item.durability);
                        console.log(playerObj);
                        break;
                    case "Weapon":
                        playerObj.inventory[WEAPON_INDEX] = item;
                        updatePlayerStatus("setWeapon", item.durability);
                        console.log(playerObj);
                        break;
                }
                return 0;
            }

            function createGameEvents(){
                var loseGame = {"text": "You died",
                "gameEvent": function() {
                    loserPic.style.display = "block";
                    clearInterval(timerId);
                }, "choices" : []};
                var addMushroomToInventory = {"add": function() {addItemToInventory("Mushroom")}};
                var addArmourToInventory = {"add": function() {addItemToInventory("Armour")}};
                var addWeaponToInventory = {"add": function() {addItemToInventory("Weapon")}};
                var keepChasing = {"text" : "You jump but don't make it across the chasm and fall into spikes at the bottom of a pit dying instantly", "choices": ["Continue"], "outcomes": [loseGame]};
                var blackDoor = {"text" : "You open the door, and made it out", "choices": ["Continue"], "outcomes": [winGame]};
                var redDoor = {"text" : "You open the door, and fall into an abyss plumeting to your death",
                "gameEvent": function() {
                    playerObj.health = 0;
                    updatePlayerStatus("setH", playerObj.health);
                }, "choices": ["Continue"], "outcomes": [loseGame]};
                var doors = {"text" : "You have no way of knowing what is behind either of the doors, all you can do is choose wisely ", "choices": ["Open the black door", "Open the red door"], "outcomes": [blackDoor, redDoor]};
                var stairs3 = {"text" : "You walk up the stairs and at the top of the stairs you see two doors in front of you", "choices": ["Continue"], "outcomes": [doors]};
                var exitRoom3 = {"text" : "You wake up and see some stairs just outside the room", "choices": ["Go up the stairs"], "outcomes": [stairs3]};
                var pass = {"text" : "You notice a huge welt on your head just before passing out",
                "gameEvent": function() {
                    playerObj.sanity -= 10;
                    updatePlayerStatus("setS", playerObj.sanity);
                }, "choices": ["Continue"], "outcomes": [exitRoom3]};
                var sprintAfter = {"text" : "While sprinting after the goblin you trip then...",
                "gameEvent": function() {
                    playerObj.health -= 25;
                    updatePlayerStatus("setH", playerObj.health);
                }, "choices": ["Get back up and jump after the goblin", "Take a moment to look over your wounds"], "outcomes": [keepChasing, pass]};
                var door2 = {"text" : "You open the door, but break your sword in the process. Luckily you have found a way out!",
                "gameEvent": function() {
                    playerObj.inventory[WEAPON_INDEX].durability = 0;
                    updatePlayerStatus("setWeapon", playerObj.inventory[WEAPON_INDEX].durability);
                }, "choices": ["Continue"], "outcomes": [winGame]};
                var hall2 = {"text" : "You walk down the hall and find a door that seems to be jammed shut", "choices": ["Use your sword to try and open it"], "outcomes": [door2]};
                var search = {"text" : "You reach out to grab the shiny object and a spike trap is set off instantly killing you",
                "gameEvent": function() {
                    playerObj.health = 0;
                    updatePlayerStatus("setH", playerObj.health);
                }, "choices": ["Continue"], "outcomes": [loseGame]};
                var stairs2 = {"text" : "You begin walking up the stairs and see something shiny hanging over a ledge to your right", "choices": ["Investigate the shiny object"], "outcomes": [search]};
                //After killing the goblin
                var find = {"text" : "You find a dimly lit hall and stairs which seem to lead to a way out", "choices": ["Venture down the hall", "Try going up the stairs"], "outcomes": [hall2, stairs2]};
                
                var roomOne = {"text" : "You walk into the room, and get scared to death",
                "gameEvent": function() {
                    playerObj.sanity = 0;
                    updatePlayerStatus("setS", playerObj.sanity);
                }, "choices": ["Continue"], "outcomes": [loseGame]};
                var door = {"text" : "You open the door, and make it out of the dungeon and have escaped!", "choices": ["Continue"], "outcomes": [winGame]};
                var stairs = {"text" : "You walk up the stairs, and find another door", "choices": ["open the yellow door"], "outcomes": [door]};
                var doorOne = {"text" : "You open the door to find stairs", "choices": ["stairs"], "outcomes": [stairs]};
                var doorTwo = {"text" : "You walk into the room, and get scared to death",
                "gameEvent": function() {
                    playerObj.sanity = 0;
                    updatePlayerStatus("setS", playerObj.sanity);
                }, "choices": ["Continue"], "outcomes": [loseGame]};
                var roomTwo = {"text" : "You enter the cold room and find two doors", "choices": ["Open the brown door", "Open the green door"], "outcomes": [doorOne, doorTwo]};
                var hall = {"text" : "You start your way down the hall and notice two rooms on either side.", "choices": ["Enter through the cobwebs to the room on the left", "Enter the cold room on your right"], "outcomes": [roomOne, roomTwo]};
                // Hall has few paths some are good others bad, stairs leads up to the door
                var exitRoom2 = {"text" : "You find a hall and stairs, choose wisely", "choices": ["go down the hall", "go up the stairs"], "outcomes": [hall, stairs]};
                // Continue to room 2
                var exitRoom1 = {"text" : "You exit the room and enter a new one", "choices": ["Continue on to the next room"], "outcomes": [exitRoom2]};
                //Screaming option
                var run = {"text" : "You manage to run away from the goblin", "choices": ["Exit room"], "outcomes": [exitRoom1]};
                var kill = {"text" : "Using your torch you avoid the obstacles in the dungeon and finally kill the goblin",
                "gameEvent": function() {
                    playerObj.sanity += 10;
                    updatePlayerStatus("setS", playerObj.sanity);
                }, "choices": ["Continue walking through the dungeon"], "outcomes": [find]};
                var chase = {"text" : "You chase the goblin through the darkness", "choices": ["Sprint after him!", "Grab a torch to light your way"], "outcomes": [sprintAfter, kill]};
                var useSword = {"text" : "You hurt the goblin, damaging your sword in the process, and the goblin runs away", 
                "gameEvent": function() {
                    playerObj.inventory[WEAPON_INDEX].durability -= 2;
                    updatePlayerStatus("setWeapon", playerObj.inventory[WEAPON_INDEX].durability);
                }, "choices": ["chase"], "outcomes": [chase]};
                var screamHelp = {"text" : "A goblin comes from around the corner and hits you, damaging your armour", 
                "gameEvent": function() {
                    if (playerObj.inventory[ARMOUR_INDEX].durability > 0){
                        playerObj.inventory[ARMOUR_INDEX].durability -= 10;
                        updatePlayerStatus("setArmour", playerObj.inventory[ARMOUR_INDEX].durability);
                    } else {
                        playerObj.health -= 10;
                        updatePlayerStatus("setH", playerObj.health);
                    }
                }, "choices": ["use sword", "run"], "outcomes": [useSword, run]};
                //Search again but after this have to exit the room.
                var searchAgain = {"text" : "You find nothing again and are really starting to go insane!", 
                "gameEvent": function() {
                    playerObj.sanity -= 10;
                    updatePlayerStatus("setS", playerObj.sanity);
                },
                "choices": ["exit room"], "outcomes": [exitRoom1]};
                // Either keep searching (lose sanity) or exit room1
                var searchRoom = {"text" : "You search the room and find nothing, but you start to feel like you are going insane", 
                "gameEvent": function() {
                    playerObj.sanity -= 5;
                    updatePlayerStatus("setS", playerObj.sanity);
                },
                "choices": ["Search again", "exit room"], "outcomes": [searchAgain, exitRoom1]};
                // START EVENT
                var gameEvent1 = {"text" : "You wake up in a cold dungeon, but you have no idea how you got there.", "choices": ["Search Room", "Scream for help"], "outcomes": [searchRoom, screamHelp]};
                GAME_EVENTS.push(gameEvent1);
            }


            function updateChoices(event){
                // Added for automatic win
                if (event.text == "You made it out"){
                    event.gameEvent();
                }
                if (event.text) {
                    var storyText = document.getElementById("storyContainer");
                    storyText.innerText = event.text;
                    for(var i = 0; i<event.choices.length; i++){
                        var num = i + 1;
                        var choice = document.getElementById("Choice" + num);
                        choice.innerText = event.choices[i] + " (" + num + ")";
                        if (choice.style.display === "none") {
                            choice.style.display = "block";
                        }
                    }
                    for(var i = event.choices.length; i<MAX_CHOICES; i++){
                        var num = i + 1;
                        document.getElementById("Choice" + num).style.display = "none";
                    }
                } else {   
                    console.log("No choices to update. Player probably bought something.")
                }
            }

            id = setInterval(checkIfPlayerStatusNeedsUpdate,250);

            function checkIfPlayerStatusNeedsUpdate() {
                if (playerObj.sanity < 40 || playerObj.health < 100) {
                    updatePlayerStatus("alright");
                } else {
                    updatePlayerStatus("happy");
                }
                if (playerObj.sanity < 20 || playerObj.health < 50) {
                    updatePlayerStatus("sad");
                }
                if (playerObj.sanity <= 0 || playerObj.health <= 0) {
                    updatePlayerStatus("dead");
                }
            }
            
            function main() {
                createGameEvents();
                var startEvent = GAME_EVENTS[0];
                updateChoices(startEvent);
                currentEvent = startEvent;
            }


            setupPlayer();
            main();

        </script>
    </body>
</html>
